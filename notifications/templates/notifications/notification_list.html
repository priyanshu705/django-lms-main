{% extends "base.html" %}
{% load static %}

{% block title %}Notifications - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    .notification-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        margin-bottom: 2rem;
    }
    
    .notification-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        margin-bottom: 1rem;
        backdrop-filter: blur(8px);
        background: rgba(255,255,255,0.95);
    }
    
    .notification-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .notification-card.unread {
        border-left: 4px solid #007bff;
        background: rgba(0,123,255,0.02);
    }
    
    .notification-icon {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
    }
    
    .filter-card {
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(8px);
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.08);
    }
    
    .priority-badge {
        font-size: 0.7rem;
        padding: 3px 8px;
        border-radius: 15px;
        font-weight: 600;
    }
    
    .btn-action {
        border-radius: 20px;
        padding: 0.375rem 1rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .notification-stats {
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(8px);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-item {
        text-align: center;
        padding: 1rem;
        border-radius: 10px;
        background: rgba(0,123,255,0.05);
        margin: 0.5rem;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }
    
    .pagination-wrapper {
        display: flex;
        justify-content: center;
        margin-top: 2rem;
    }
    
    .page-link {
        border-radius: 8px;
        margin: 0 2px;
        border: none;
        color: #007bff;
    }
    
    .page-link:hover {
        background-color: #007bff;
        color: white;
    }
    
    .page-item.active .page-link {
        background-color: #007bff;
        border-color: #007bff;
        border-radius: 8px;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .notification-card {
        animation: slideIn 0.3s ease-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="notification-header p-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2 fw-bold">
                    <i class="fas fa-bell me-3"></i>My Notifications
                </h1>
                <p class="mb-0 opacity-90">
                    Stay updated with your learning progress, achievements, and important announcements
                </p>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="d-flex flex-wrap gap-2 justify-content-md-end">
                    <button class="btn btn-light btn-action" onclick="markAllAsRead()">
                        <i class="fas fa-check-double me-2"></i>Mark All Read
                    </button>
                    <button class="btn btn-outline-light btn-action" onclick="refreshNotifications()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                    <a href="{% url 'notifications:notification_preferences' %}" class="btn btn-outline-light btn-action">
                        <i class="fas fa-cog me-2"></i>Settings
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Section -->
    <div class="notification-stats">
        <div class="row">
            <div class="col-6 col-md-3">
                <div class="stat-item">
                    <div class="h3 mb-1 text-primary fw-bold" id="totalCount">{{ total_count }}</div>
                    <div class="small text-muted">Total</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-item">
                    <div class="h3 mb-1 text-warning fw-bold" id="unreadCount">{{ unread_count }}</div>
                    <div class="small text-muted">Unread</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-item">
                    <div class="h3 mb-1 text-success fw-bold" id="todayCount">{{ today_count }}</div>
                    <div class="small text-muted">Today</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-item">
                    <div class="h3 mb-1 text-info fw-bold" id="weekCount">{{ week_count }}</div>
                    <div class="small text-muted">This Week</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Filters Sidebar -->
        <div class="col-lg-3 mb-4">
            <div class="filter-card card h-100">
                <div class="card-header bg-transparent border-0 pb-0">
                    <h5 class="mb-0 fw-bold text-primary">
                        <i class="fas fa-filter me-2"></i>Filters
                    </h5>
                </div>
                <div class="card-body">
                    <form id="filterForm" onsubmit="applyFilters(event)">
                        <!-- Status Filter -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">Status</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="status" value="all" id="statusAll" checked>
                                <label class="form-check-label" for="statusAll">
                                    All Notifications
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="status" value="unread" id="statusUnread">
                                <label class="form-check-label" for="statusUnread">
                                    Unread Only
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="status" value="read" id="statusRead">
                                <label class="form-check-label" for="statusRead">
                                    Read Only
                                </label>
                            </div>
                        </div>

                        <!-- Type Filter -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">Type</label>
                            <select class="form-select" name="type" id="typeFilter">
                                <option value="">All Types</option>
                                <option value="progress_update">Progress Updates</option>
                                <option value="course_completion">Course Completions</option>
                                <option value="video_completion">Video Completions</option>
                                <option value="achievement">Achievements</option>
                                <option value="announcement">Announcements</option>
                                <option value="reminder">Reminders</option>
                                <option value="milestone">Milestones</option>
                                <option value="welcome">Welcome Messages</option>
                            </select>
                        </div>

                        <!-- Priority Filter -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">Priority</label>
                            <select class="form-select" name="priority" id="priorityFilter">
                                <option value="">All Priorities</option>
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>

                        <!-- Date Range Filter -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">Date Range</label>
                            <select class="form-select" name="date_range" id="dateRangeFilter">
                                <option value="">All Time</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>

                        <!-- Custom Date Range -->
                        <div class="mb-4" id="customDateRange" style="display: none;">
                            <label class="form-label fw-semibold">From</label>
                            <input type="date" class="form-control mb-2" name="date_from" id="dateFrom">
                            <label class="form-label fw-semibold">To</label>
                            <input type="date" class="form-control" name="date_to" id="dateTo">
                        </div>

                        <!-- Apply Filters Button -->
                        <button type="submit" class="btn btn-primary w-100 btn-action">
                            <i class="fas fa-search me-2"></i>Apply Filters
                        </button>
                        
                        <!-- Clear Filters Button -->
                        <button type="button" class="btn btn-outline-secondary w-100 mt-2 btn-action" onclick="clearFilters()">
                            <i class="fas fa-times me-2"></i>Clear Filters
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Notifications List -->
        <div class="col-lg-9">
            <!-- Loading State -->
            <div id="loadingState" class="text-center py-5" style="display: none;">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="text-muted">Loading notifications...</div>
            </div>

            <!-- Notifications Container -->
            <div id="notificationsContainer">
                {% if notifications %}
                    {% for notification in notifications %}
                        {% include 'notifications/notification_item.html' with notification=notification %}
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-bell-slash mb-3" style="font-size: 4rem; opacity: 0.3;"></i>
                        <h4 class="mb-3">No notifications found</h4>
                        <p class="mb-4">You don't have any notifications yet. When you do, they'll appear here.</p>
                        <a href="{% url 'core:dashboard' %}" class="btn btn-primary btn-action">
                            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                        </a>
                    </div>
                {% endif %}
            </div>

            <!-- Pagination -->
            {% if is_paginated %}
                <div class="pagination-wrapper">
                    <nav aria-label="Notifications pagination">
                        <ul class="pagination">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.priority %}&priority={{ request.GET.priority }}{% endif %}">
                                        <i class="fas fa-angle-double-left"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.priority %}&priority={{ request.GET.priority }}{% endif %}">
                                        <i class="fas fa-angle-left"></i>
                                    </a>
                                </li>
                            {% endif %}

                            {% for num in page_obj.paginator.page_range %}
                                {% if page_obj.number == num %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ num }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.priority %}&priority={{ request.GET.priority }}{% endif %}">{{ num }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.priority %}&priority={{ request.GET.priority }}{% endif %}">
                                        <i class="fas fa-angle-right"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.priority %}&priority={{ request.GET.priority }}{% endif %}">
                                        <i class="fas fa-angle-double-right"></i>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3"></div>
{% endblock %}

{% block extra_js %}
<script>
// Notification management functions
function markAllAsRead() {
    if (!confirm('Mark all notifications as read?')) return;
    
    fetch('/notifications/api/mark-all-read/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update UI
            document.querySelectorAll('.notification-card.unread').forEach(card => {
                card.classList.remove('unread');
                const badge = card.querySelector('.unread-indicator');
                if (badge) badge.remove();
            });
            
            // Update counters
            document.getElementById('unreadCount').textContent = '0';
            
            showToast('All notifications marked as read', 'success');
        } else {
            showToast('Error marking notifications as read', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error marking notifications as read', 'error');
    });
}

function markAsRead(notificationId, element) {
    fetch(`/notifications/api/mark-read/${notificationId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const card = element.closest('.notification-card');
            card.classList.remove('unread');
            
            const badge = card.querySelector('.unread-indicator');
            if (badge) badge.remove();
            
            // Update unread count
            const unreadCount = document.getElementById('unreadCount');
            const currentCount = parseInt(unreadCount.textContent);
            unreadCount.textContent = Math.max(0, currentCount - 1);
        }
    })
    .catch(error => console.error('Error:', error));
}

function deleteNotification(notificationId, element) {
    if (!confirm('Delete this notification?')) return;
    
    fetch(`/notifications/api/delete/${notificationId}/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const card = element.closest('.notification-card');
            card.style.animation = 'slideOut 0.3s ease-out';
            
            setTimeout(() => {
                card.remove();
                
                // Update counters
                const totalCount = document.getElementById('totalCount');
                totalCount.textContent = Math.max(0, parseInt(totalCount.textContent) - 1);
                
                if (card.classList.contains('unread')) {
                    const unreadCount = document.getElementById('unreadCount');
                    unreadCount.textContent = Math.max(0, parseInt(unreadCount.textContent) - 1);
                }
                
                // Check if container is empty
                const container = document.getElementById('notificationsContainer');
                if (container.children.length === 0) {
                    location.reload(); // Reload to show empty state
                }
            }, 300);
            
            showToast('Notification deleted', 'success');
        } else {
            showToast('Error deleting notification', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error deleting notification', 'error');
    });
}

function refreshNotifications() {
    location.reload();
}

// Filter management
function applyFilters(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const params = new URLSearchParams();
    
    for (let [key, value] of formData.entries()) {
        if (value) {
            params.append(key, value);
        }
    }
    
    // Add current filters to URL
    const url = new URL(window.location);
    url.search = params.toString();
    
    // Show loading state
    showLoadingState();
    
    // Navigate to filtered results
    window.location.href = url.toString();
}

function clearFilters() {
    document.getElementById('filterForm').reset();
    document.getElementById('customDateRange').style.display = 'none';
    
    // Navigate to clear URL
    window.location.href = window.location.pathname;
}

function showLoadingState() {
    document.getElementById('loadingState').style.display = 'block';
    document.getElementById('notificationsContainer').style.display = 'none';
}

// Date range handling
document.getElementById('dateRangeFilter').addEventListener('change', function() {
    const customRange = document.getElementById('customDateRange');
    if (this.value === 'custom') {
        customRange.style.display = 'block';
        customRange.style.animation = 'slideIn 0.3s ease-out';
    } else {
        customRange.style.display = 'none';
    }
});

// Utility functions
function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.querySelector('meta[name="csrf-token"]')?.content || '';
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    const container = document.querySelector('.toast-container');
    container.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Set filter values from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    
    ['status', 'type', 'priority', 'date_range', 'date_from', 'date_to'].forEach(param => {
        const value = urlParams.get(param);
        if (value) {
            const element = document.getElementById(param + 'Filter') || document.querySelector(`[name="${param}"]`);
            if (element) {
                if (element.type === 'radio') {
                    const radio = document.querySelector(`[name="${param}"][value="${value}"]`);
                    if (radio) radio.checked = true;
                } else {
                    element.value = value;
                }
            }
        }
    });
    
    // Show custom date range if needed
    if (urlParams.get('date_range') === 'custom') {
        document.getElementById('customDateRange').style.display = 'block';
    }
});

// Add slide out animation
const style = document.createElement('style');
style.textContent = `
    @keyframes slideOut {
        from {
            opacity: 1;
            transform: translateX(0);
        }
        to {
            opacity: 0;
            transform: translateX(100%);
        }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}